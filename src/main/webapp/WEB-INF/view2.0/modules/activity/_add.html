<#include "../../_layout/_layout2.0.html"><#t>
<@header/>
<div style="margin: 15px" id="form-save">
	<form class="layui-form layui-form-pane">
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>活动标题：</label>
			<div class="layui-input-block">
				<input type="text" name="title" autocomplete="off" class="layui-input" lay-verify="title" value="${data.title!''}">
				<input type="hidden" name="pid" value="${data.pid!''}" id="pid">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">活动副标题：</label>
			<div class="layui-input-block">
				<input type="text" name="title" autocomplete="off" class="layui-input" lay-verify="subTitle" value="${data.subTitle!''}">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>地点：</label>
			<div class="layui-input-block">
				<input type="text" name="address"  autocomplete="off" class="layui-input" value="${data.address!''}" lay-verify="address">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>票价：</label>
			<div class="layui-input-inline">
				<#if data.price??>
				   <input type="text" name="price" autocomplete="off" class="layui-input" lay-verify="price" value="${data.price?string('#.##')}">
				<#else>
				   <input type="text" name="price" autocomplete="off" class="layui-input" lay-verify="price">
				</#if>
			</div>
			<label class="layui-form-label" style="width: 130px;"><span>*</span>活动时间：</label>
			<div class="layui-input-inline">
				<#if data.activityStartTime??>
					<input type="text" name="activityStartTime" placeholder="开始时间"  value="${data.activityStartTime?string('yyyy-MM-dd HH:mm:ss')}" autocomplete="off" class="layui-input" id="activity-start-time">
					<#else>
						<input type="text" name="activityStartTime" placeholder="开始时间"  autocomplete="off" class="layui-input" id="activity-start-time">
				</#if>
			</div>
			<div class="layui-input-inline">
				<#if data.activityEndTime??>
					<input type="text" name="activityEndTime" placeholder="结束时间" lay-verify="required" value="${data.activityEndTime?string('yyyy-MM-dd HH:mm:ss')}" autocomplete="off" class="layui-input" id="activity-end-time">
					<#else>
						<input type="text" name="activityEndTime" placeholder="结束时间" lay-verify="required" autocomplete="off" class="layui-input" id="activity-end-time">
				</#if>
			</div>
			<div class="layui-form-mid layui-word-aux">(不填活动开始时间则默认是创建时间)</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>活动类型：</label>
			<div class="layui-input-inline">
				<select name="catId" lay-verify="required">
					<option value="">请选择</option>
					<@module name="option" class="com.wzxy.label.impl.GetActivityCategory" type="1"/>
				</select>
			</div>
			<label class="layui-form-label" style="width: 130px;"><span>*</span>报名截止时间：</label>
			<div class="layui-input-inline">
				<#if data.applyStartTime??>
					<input type="text" name="applyStartTime" placeholder="开始时间" lay-verify="required" value="${data.applyStartTime?string('yyyy-MM-dd HH:mm:ss')}" autocomplete="off" class="layui-input" id="apply-start-time">
					<#else>
						<input type="text" name="applyStartTime" placeholder="开始时间" lay-verify="required" autocomplete="off" class="layui-input" id="apply-start-time">
				</#if>
			</div>
			<div class="layui-input-inline">
				<#if data.applyEndTime??>
					<input type="text" name="applyEndTime" placeholder="结束时间" value="${data.applyEndTime?string('yyyy-MM-dd HH:mm:ss')}" autocomplete="off" class="layui-input" id="apply-end-time">
					<#else>
						<input type="text" name="applyEndTime" placeholder="结束时间"  autocomplete="off" class="layui-input" id="apply-end-time">
				</#if>
			</div>
			<div class="layui-form-mid layui-word-aux">(不填报名结束时间默认是活动开始前一小时)</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>合作商家：</label>
			<div class="layui-input-inline">
				<select name="supplierId" lay-verify="required">
					<option value="">请选择</option>
					<@module name="option" class="com.wzxy.label.impl.GetSupplierNode" type="1" checked="${data.supplierId!''}"/>
				</select>
			</div>
			<label class="layui-form-label" style="width: 130px;"><span>*</span>报名人数上限：</label>
			<div class="layui-input-inline">
				<input type="number" name="stock" autocomplete="off" class="layui-input" lay-verify="required" value="${data.stock!''}">
			</div>
			<label class="layui-form-label" style="width: 120px;">免费邀请人数：</label>
			<div class="layui-input-inline">
				<input type="number" name="carryNumber" autocomplete="off" class="layui-input" value="${data.carryNumber!0}">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">浏览人数：</label>
			<div class="layui-input-inline">
				<input type="number" name="browse" autocomplete="off" class="layui-input" value="${data.browse!''}">
			</div>
			<label class="layui-form-label" style="width: 130px;">想去人数：</label>
			<div class="layui-input-inline">
				<input type="number" name="wantNumber" autocomplete="off" class="layui-input" value="${data.wantNumber!''}">
			</div>
			<label class="layui-form-label"><span>*</span>产品权重：</label>
			<div class="layui-input-inline">
				<input type="number" name="weight" placeholder="请输入产品权重越大越靠前" autocomplete="off" class="layui-input" value="${data.weight!''}" lay-verify="required">
			</div>
			<div class="layui-form-mid layui-word-aux">(权重越大活动排名越靠前)</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">活动标签：</label>
			<div class="layui-input-inline" style="width: 250px;">
				<input type="text" name="label" class="layui-input" value="${data.label!''}">
			</div>
			<div class="layui-form-mid layui-word-aux">注意：(活动标签内容之间以，隔开)</div>
		</div>
		<div class="layui-form-item">
			<fieldset class="layui-elem-field layui-field-title">
				<legend><span style="color: red;">*</span>上传封面图片：</legend>
			</fieldset>
			<div class="layui-input-inline">
				<div class="layui-upload-drag" id="img-url">
					<#if data.imageUrl??>
						<input type='hidden' name='imageUrl' value="${data.imageUrl!''}"> <img width='200' src="${data.imageUrl!''}">
						<#else>
						<i class="layui-icon"></i>
						<p>点击上传</p>
					</#if>
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<fieldset class="layui-elem-field layui-field-title">
				<legend><span style="color: red;">*</span>上传轮播图片：</legend>
			</fieldset>
			<button type="button" class="layui-btn" id="imglist-url" style="margin-left: 3px;">多图片上传</button>
			<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
				预览图：
				<div class="layui-upload-list" id="img-list">
					<#if data.imageList??>
					<#list data.imageList as img>
						<div class="layui-img-item">
							<img src="${img.url!''}" alt="img" class="layui-upload-img">
							<input type='hidden' value="${img.url!''}">
							<div class="layui-fun-list">
								<span class="del-img"><i class='layui-icon'>&#xe640;</i></span>
							</div>
						</div>
					</#list>
					</#if>
				</div>
			</blockquote>
		</div>
		<div class="layui-form-item layui-form-text">
			<label class="layui-form-label">活动详情：</label>
			<div class="layui-input-block product-info">
				<input type="hidden" name ="info" id="info"></input>
				<div id="activity-info">${data.info!''}</div>
			</div>
		</div>
		<div class="layui-form-item layui-fixed">
			<div class="layui-block">
				<button class="layui-btn" type="button" id="submit">立即提交</button>
				<button class="layui-btn layui-btn-primary" id="cancel">取消</button>
			</div>
		</div>
	</form>
</div>
<@footer>

<script>
	//入口
	layui.use(['laydate','upload','form'], function() {
		var $ = layui.jquery;
		var form = layui.form,laydate = layui.laydate,upload = layui.upload;
        //常规用法
        laydate.render({elem: '#apply-end-time',type: 'datetime'});
        laydate.render({elem: '#apply-start-time',type: 'datetime'});
        laydate.render({elem: '#activity-end-time',type: 'datetime'});
        laydate.render({elem: '#activity-start-time',type: 'datetime'});
        //自定义验证规则
        form.verify({
            title: function (value) {
                if(!/^.{3,150}$/.test(value)){
                    return '标题必须3到150位！';
                }
            },
            address: function (value) {
                if(!/^.{3,50}$/.test(value)){
                    return '地点必须3到50位！';
                }
            },
            price: function(value){
                if(!/^[0-9]+([.]{1}[0-9]+){0,1}$/.test(value)){
                    return '价格只能是整数或小数！';
                }
            }
        });
        //初始化一个编辑器
        var activityInfoIndex = new Editor().init({
            editorEm: $('#activity-info'),	//产品介绍
            minHeight: 250

        })
        //多图片上传
        upload.render({
            elem: '#imglist-url'
            ,url: '${ctx}upload'
            ,multiple: true
            ,before: function(obj){
                var index = layer.msg('图片上传中...', {
                    icon: 16,
                    shade: 0.01,
                    time: 0
                })
            },done: function(res,index){
                layer.close(layer.msg());//关闭上传提示窗口
                //上传完毕
                var html = "";
                if (res.code == 0) {
                    html = "<div class='layui-img-item'>"
                        +"<img src="+ res.data[0] +" class='layui-upload-img'>"
                        +"<input type='hidden' value="+ res.data[0] +">"
                        +"<div class='layui-fun-list'>"
                        +"<span class='del-img'><i class='layui-icon'>&#xe640;</i></span>"
                        +"</div>"
                        +"</div>";
                }
                $('#img-list').append(html);
                //轮播图片删除
                $(".del-img").on('click',function () {
                    var $img = $(this).parent().parent();
                    $img.remove();
                });
            }
        });
        //轮播图片删除
        $(".del-img").on('click',function () {
            var $img = $(this).parent().parent();
            $img.remove();
        });
        //拖拽上传
        upload.render({
            elem: '#img-url'
            ,url: '${ctx}upload'
            ,done: function(res){
                var html = "<input type='hidden' name='imageUrl' value="+res.data[0]+"> <img width='200' src="+res.data[0]+">";
                $("#img-url").html(html)
            }
        });
		$("#submit").on('click', function(){
		    var isEdit = false;
            var pid = $("#pid").val();
            var url = '${ctx}activity/add';
            if(pid != '') { //根据pid是否W为空判断是添加还是更新
                url = "${ctx}activity/edit"
                isEdit = true;
            }
            //给轮播图片的隐藏表单设置name
            $(".layui-upload-list input").each(function (i,j) {
                $(this).attr("name","imageList["+i+"].url");
            })
            var content = activityInfoIndex.getCode();
            $("#info").empty();
            if (content == "") {
                layer.msg("商品内容不能为空！")
                return;
            }
            $("#info").val(content);
			var formEm = $("#form-save").find('form');
			if(!form.onVerify(formEm)){
				return false;
			}
			$.post(url,formEm.serialize(),function(result){
				if(result.code == 0){
					formEm[0].reset();	//清空弹框表单内容
					var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
					parent.layer.close(index);
					parent._tools.search(isEdit);
					return;
				}
				layer.msg(result.msg);
			});
		});
        $("#cancel").on('click',function () {
            var formEm = $("#form-save").find('form')[0].reset();
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
            parent._tools.search();
        });
	});
</script>
</@footer>
<style type="text/css">
	.layui-elem-field legend {
		margin-left: 20px;
		padding: 0 10px;
		font-size: 12px;
		font-weight: 500;
	}
	.layui-form-item.layui-fixed {
		margin-top: 20px;
		position: fixed;
		right: 20px;
		bottom: 0px;
	}
</style>